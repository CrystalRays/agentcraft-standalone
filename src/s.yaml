edition: 1.0.0
name: agentcraft
vars:
  region: '{{ region }}'
  service:
    name: '{{ serviceName }}'
    description: '部署AgentCraft到函数计算'
    internetAccess: true
    logConfig: auto
    nasConfig: auto
services:
  agentcraft-backend:
    component: fc
    props:
      region: ${vars.region}
      service: ${vars.service}
      function:
        handler: index.handler
        description: AgentCraft后端API服务
        timeout: 7200
        caPort: 8000
        layers:
          - acs:fc:cn-hangzhou:1431999136518149:layers/NLP-Python310/versions/1
          - acs:fc:cn-hangzhou:1431999136518149:layers/FastAPI-Python310/versions/6
        customRuntimeConfig:
          command:
            - python3
            - '-u'
            - app/main.py
        instanceType: c1
        runtime: custom.debian10
        instanceConcurrency: 10
        cpu: 8
        memorySize: 16384
        diskSize: 10240
        environmentVariables:
          PATH: >-
            /var/fc/lang/python3.10/bin::/usr/local/bin/apache-maven/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ruby/bin:/opt/bin:/code:/code/bin
          PYTHONPATH: /opt/python:/code
          # AK: ${env.AK}
          # SK: ${env.SK}
          
          # REDIS_HOST: '{{REDIS_HOST}}'
          EMBEDDING_TIMEOUT: '600'
          WORKERS: '1'
          POSTGRES_HOST: '{{POSTGRES_HOST}}'
          POSTGRES_DATABASE: '{{POSTGRES_DATABASE}}'
          POSTGRES_USER: '{{POSTGRES_USER}}'
          POSTGRES_PASSWORD: '{{POSTGRES_PASSWORD}}'
          EMBEDDING_TOKEN: ''
          CREATE_TABLES: '1' # 是否建表
          EMBEDDING_URL: '{{EMBEDDING_URL}}' # embedding 服务地址
          EMBEDDING_DIM: '{{EMBEDDING_DIM}}' # 向量维度
          JWT_SECRET: {{JWT_SECRET}}
          # REDIS_PASSWORD: {{REDIS_PASSWORD}}
          # REDIS_USER: {{REDIS_USER}}
          # USE_GREEN_CLIENT: 1
        name: agentcraft-backend
        asyncConfiguration: {}
        codeUri: './agentcraft-all/agentcraft-be'
      triggers:
        - name: httpTrigger
          description: ''
          type: http
          config:
            methods:
              - GET
              - POST
              - PUT
              - DELETE
              - HEAD
              - OPTIONS
            authType: anonymous
            disableURLInternet: false
      customDomains:
        - domainName: auto
          protocol: HTTP
          routeConfigs:
            - path: /*
  agentcraft-frontend:
    component: fc
    props:
      region: ${vars.region}
      service: ${vars.service}
      function:
        name: agentcraft-frontend
        description: AgentCraft前端服务
        handler: index.handler
        timeout: 600
        diskSize: 512
        caPort: 8000
        instanceType: c1
        runtime: custom.debian10
        cpu: 1
        instanceConcurrency: 100
        memorySize: 1024
        layers:
          - acs:fc:${vars.region}:official:layers/Python310/versions/2
          - acs:fc:${vars.region}:official:layers/Python310-Package-Collection/versions/2
          - acs:fc:${vars.region}:official:layers/Python3-Flask2x/versions/2
        environmentVariables:
          baseUrl: '${agentcraft-backend.output.url.system_intranet_url}'
          PYTHONPATH: /opt/python:/code:/code/python
          LD_LIBRARY_PATH: /code:/code/lib:/usr/local/lib:/opt/lib:/opt/php8.1/lib:/opt/php8.0/lib:/opt/php7.2/lib
          PATH: /opt/python3.10/bin:/usr/local/bin/apache-maven/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ruby/bin:/opt/bin:/code:/code/bin
        codeUri: ./agentcraft-all/agentcraft-fe
      triggers:
        - name: defaultTrigger
          description: ''
          type: http
          qualifier: LATEST
          config:
            methods:
              - GET
              - POST
              - PUT
              - DELETE
            authType: anonymous
            disableURLInternet: false
      customDomains:
        - domainName: auto
          protocol: HTTP
          routeConfigs:
            - path: /*